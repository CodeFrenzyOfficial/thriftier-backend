name: Backend Staging Deployment

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: "20.x"

    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build TypeScript
        run: npm run build

      - name: ğŸ§ª Run tests (if available)
        run: npm test || echo "No tests found"
        continue-on-error: true

      - name: ğŸ“‹ Create deployment package
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
          JWT_ACCESS_EXPIRATION: ${{ secrets.STAGING_JWT_ACCESS_EXPIRATION }}
          JWT_REFRESH_EXPIRATION: ${{ secrets.STAGING_JWT_REFRESH_EXPIRATION }}
          CORS_ORIGIN: ${{ secrets.STAGING_CORS_ORIGIN }}
          OTP_TTL_MINUTES: ${{ secrets.STAGING_OTP_TTL_MINUTES }}
          OTP_MAX_ATTEMPTS: ${{ secrets.STAGING_OTP_MAX_ATTEMPTS }}
          OTP_RESEND_COOLDOWN_SECONDS: ${{ secrets.STAGING_OTP_RESEND_COOLDOWN_SECONDS }}
          RESET_TOKEN_TTL_MINUTES: ${{ secrets.STAGING_RESET_TOKEN_TTL_MINUTES }}
          FRONTEND_URL: ${{ secrets.STAGING_FRONTEND_URL }}
          LOG_LEVEL: ${{ secrets.STAGING_LOG_LEVEL }}
          SENDGRID_FROM_NAME: ${{ secrets.STAGING_SENDGRID_FROM_NAME }}
          SENDGRID_FROM_EMAIL: ${{ secrets.STAGING_SENDGRID_FROM_EMAIL }}
          SENDGRID_API_KEY: ${{ secrets.STAGING_SENDGRID_API_KEY }}
        run: |
          set -euo pipefail

          # Fail fast if required secrets are missing/empty (prevents Prisma P1012 later)
          if [ -z "${DATABASE_URL:-}" ]; then
            echo "âŒ STAGING_DATABASE_URL secret is empty or missing"
            exit 1
          fi
          mkdir -p deploy
          cp -r dist deploy/
          cp -r prisma deploy/
          cp package*.json deploy/

          # Create .env file locally with actual values
          {
            echo "# Auth Variables"
            echo "OTP_TTL_MINUTES=$OTP_TTL_MINUTES"
            echo "OTP_MAX_ATTEMPTS=$OTP_MAX_ATTEMPTS"
            echo "OTP_RESEND_COOLDOWN_SECONDS=$OTP_RESEND_COOLDOWN_SECONDS"
            echo "JWT_SECRET=$JWT_SECRET"
            echo "JWT_ACCESS_EXPIRATION=$JWT_ACCESS_EXPIRATION"
            echo "JWT_REFRESH_EXPIRATION=$JWT_REFRESH_EXPIRATION"
            echo "RESET_TOKEN_TTL_MINUTES=$RESET_TOKEN_TTL_MINUTES"
            echo ""
            echo "# Frontend URL"
            echo "FRONTEND_URL=$FRONTEND_URL"
            echo ""
            echo "# Server Variables"
            echo "NODE_ENV=staging"
            echo "PORT=8000"
            echo "LOG_LEVEL=$LOG_LEVEL"
            echo ""
            echo "# Database"
            echo "DATABASE_URL=$DATABASE_URL"
            echo ""
            echo "# Twilio SendGrid API"
            echo "SENDGRID_FROM_NAME=$SENDGRID_FROM_NAME"
            echo "SENDGRID_FROM_EMAIL=$SENDGRID_FROM_EMAIL"
            echo "SENDGRID_API_KEY=$SENDGRID_API_KEY"
            echo ""
            echo "# CORS"
            echo "CORS_ORIGIN=$CORS_ORIGIN"
          } > deploy/.env

          tar -czf deploy.tar.gz deploy/

      - name: ğŸ” Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: ğŸ“¤ Deploy to staging server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_PATH: ${{ secrets.STAGING_PATH }}
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
          JWT_ACCESS_EXPIRATION: ${{ secrets.STAGING_JWT_ACCESS_EXPIRATION }}
          JWT_REFRESH_EXPIRATION: ${{ secrets.STAGING_JWT_REFRESH_EXPIRATION }}
          CORS_ORIGIN: ${{ secrets.STAGING_CORS_ORIGIN }}
          OTP_TTL_MINUTES: ${{ secrets.STAGING_OTP_TTL_MINUTES }}
          OTP_MAX_ATTEMPTS: ${{ secrets.STAGING_OTP_MAX_ATTEMPTS }}
          OTP_RESEND_COOLDOWN_SECONDS: ${{ secrets.STAGING_OTP_RESEND_COOLDOWN_SECONDS }}
          RESET_TOKEN_TTL_MINUTES: ${{ secrets.STAGING_RESET_TOKEN_TTL_MINUTES }}
          FRONTEND_URL: ${{ secrets.STAGING_FRONTEND_URL }}
          LOG_LEVEL: ${{ secrets.STAGING_LOG_LEVEL }}
          SENDGRID_FROM_NAME: ${{ secrets.STAGING_SENDGRID_FROM_NAME }}
          SENDGRID_FROM_EMAIL: ${{ secrets.STAGING_SENDGRID_FROM_EMAIL }}
          SENDGRID_API_KEY: ${{ secrets.STAGING_SENDGRID_API_KEY }}
        run: |
          # Add server to known hosts
          ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts

          # Ensure deployment folder exists
          ssh $STAGING_USER@$STAGING_HOST "mkdir -p $STAGING_PATH"

          # Upload deployment package
          scp deploy.tar.gz $STAGING_USER@$STAGING_HOST:$STAGING_PATH/

          # Execute deployment script on server
          ssh $STAGING_USER@$STAGING_HOST "
            cd $STAGING_PATH

            # Backup current version
            if [ -d 'current' ]; then
              mv current backup-\$(date +%Y%m%d-%H%M%S)
            fi

            # Extract new version
            tar -xzf deploy.tar.gz
            mv deploy current
            cd current

            # Install production dependencies
            npm ci --only=production

            # .env file already included in deployment package

            # Run database migrations (Prisma auto-loads .env from current directory)
            npx prisma migrate deploy


            # Restart application (using PM2)
            pm2 restart Thrifter_Backend_Staging || pm2 start dist/index.js --name Thrifter_Backend_Staging
            pm2 save

            # Cleanup
            rm ../deploy.tar.gz

            # Keep only last 3 backups
            cd ..
            ls -t backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true

            echo 'âœ… Backend deployment completed successfully!'
          "

      - name: âœ… Deployment successful
        run: |
          echo "ğŸ‰ Backend deployed to staging successfully!"
          echo "ğŸ”— API URL: https://api.gothriftier.com/v1"
          echo "ğŸ“… Deployed at: $(date)"

      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."
